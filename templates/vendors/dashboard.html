{% extends 'base.html' %}
{% load static %}

{% block title %}{{ vendor.name }} - Vendor Dashboard - River Side Food Court{% endblock %}

{% block extra_css %}
<style>
    .order-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    .order-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .order-pending { border-left-color: #f59e0b; }
    .order-confirmed { border-left-color: #3b82f6; }
    .order-preparing { border-left-color: #8b5cf6; }
    .order-ready { border-left-color: #10b981; }

    .status-badge-pending { @apply badge-warning; }
    .status-badge-confirmed { @apply badge-info; }
    .status-badge-preparing { @apply badge-primary; }
    .status-badge-ready { @apply badge-success; }

    .notification-dot {
        width: 8px;
        height: 8px;
        background: #ef4444;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .stats-card {
        background: linear-gradient(135deg, var(--fallback-p,oklch(var(--p)/1)) 0%, var(--fallback-p,oklch(var(--p)/0.8)) 100%);
    }

    .preparing-pulse {
        animation: preparingPulse 2s ease-in-out infinite;
    }

    @keyframes preparingPulse {
        0%, 100% {
            background-color: rgb(139, 92, 246);
            transform: scale(1);
        }
        50% {
            background-color: rgb(168, 85, 247);
            transform: scale(1.05);
        }
    }

    .order-timer {
        font-family: 'Courier New', monospace;
        font-weight: bold;
    }

    .connection-indicator {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 100;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-base-100 py-6" x-data="vendorDashboard()" x-init="init()">
    <!-- Connection Status -->
    <div class="connection-indicator">
        <div x-show="!connected" class="alert alert-warning shadow-lg">
            <div>
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <span></span>Connecting...</span>
            </div>
        </div>
        <div x-show="connected" class="alert alert-success shadow-lg">
            <div>
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>Live Updates</span>
                <div class="notification-dot"></div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
            <div>
                <h1</div> class="text-3xl font-bold text-primary mb-2">{{ vendor.name }} Dashboard</h1>
                <p class="text-base-content/70">{{ vendor.get_vendor_type_display }} Vendor</p>
                <div class="text-sm text-base-content/60 mt-1">
                    Last updated: <span x-text="lastUpdated"></span>
                </div>
            </div>
            <div class="flex gap-2 mt-4 md:mt-0">
                <a href="{% url 'vendors:menu_management' vendor.id %}" class="btn btn-outline btn-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Manage Menu
                </a>
                <a href="{% url 'vendors:kitchen_display' %}" class="btn btn-primary btn-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path>
                    </svg>
                    Kitchen Display
                </a>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="stats-card stats shadow">
                <div class="stat place-items-center">
                    <div class="stat-title text-primary-content/70">Pending</div>
                    <div class="stat-value text-primary-content" x-text="stats.pending"></div>
                    <div class="stat-desc text-primary-content/60">Orders</div>
                </div>
            </div>

            <div class="stats shadow bg-info text-info-content">
                <div class="stat place-items-center">
                    <div class="stat-title text-info-content/70">Confirmed</div>
                    <div class="stat-value text-info-content" x-text="stats.confirmed"></div>
                    <div class="stat-desc text-info-content/60">Orders</div>
                </div>
            </div>

            <div class="stats shadow bg-warning text-warning-content">
                <div class="stat place-items-center">
                    <div class="stat-title text-warning-content/70">Preparing</div>
                    <div class="stat-value text-warning-content preparing-pulse" x-text="stats.preparing"></div>
                    <div class="stat-desc text-warning-content/60">Active</div>
                </div>
            </div>

            <div class="stats shadow bg-success text-success-content">
                <div class="stat place-items-center">
                    <div class="stat-title text-success-content/70">Ready</div>
                    <div class="stat-value text-success-content" x-text="stats.ready"></div>
                    <div class="stat-desc text-success-content/60">Pickup</div>
                </div>
            </div>
        </div>

        <!-- Status Filter -->
        <div class="tabs tabs-boxed mb-6 bg-base-200">
            <button @click="activeFilter = 'all'"
                    :class="activeFilter === 'all' ? 'tab-active' : ''"
                    class="tab">
                All Orders (<span x-text="filteredOrders.length"></span>)
            </button>
            <button @click="activeFilter = 'pending'"
                    :class="activeFilter === 'pending' ? 'tab-active' : ''"
                    class="tab">
                Pending (<span x-text="ordersByStatus.pending.length"></span>)
            </button>
            <button @click="activeFilter = 'confirmed'"
                    :class="activeFilter === 'confirmed' ? 'tab-active' : ''"
                    class="tab">
                Confirmed (<span x-text="ordersByStatus.confirmed.length"></span>)
            </button>
            <button @click="activeFilter = 'preparing'"
                    :class="activeFilter === 'preparing' ? 'tab-active' : ''"
                    class="tab">
                Preparing (<span x-text="ordersByStatus.preparing.length"></span>)
            </button>
            <button @click="activeFilter = 'ready'"
                    :class="activeFilter === 'ready' ? 'tab-active' : ''"
                    class="tab">
                Ready (<span x-text="ordersByStatus.ready.length"></span>)
            </button>
        </div>

        <!-- Orders Grid -->
        <div x-show="filteredOrders.length > 0" class="grid lg:grid-cols-2 xl:grid-cols-3 gap-6">
            <template x-for="orderGroup in filteredOrders" :key="orderGroup.order.id">
                <div class="order-card card bg-base-200 shadow-xl"
                     :class="'order-' + orderGroup.order.status">
                    <div class="card-body">
                        <!-- Order Header -->
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="card-title text-lg">
                                    Table <span x-text="orderGroup.order.table_number"></span>
                                </h3>
                                <div class="text-sm text-base-content/60">
                                    Order #<span x-text="orderGroup.order.id.substring(0, 8)"></span>
                                </div>
                                <div class="text-xs text-base-content/50" x-text="formatTime(orderGroup.order.created_at)"></div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold">$<span x-text="parseFloat(orderGroup.order.total_amount).toFixed(2)"></span></div>
                                <div :class="'badge status-badge-' + orderGroup.order.status" x-text="orderGroup.order.status.charAt(0).toUpperCase() + orderGroup.order.status.slice(1)"></div>
                            </div>
                        </div>

                        <!-- Order Timer -->
                        <div x-show="['preparing', 'confirmed'].includes(orderGroup.order.status)"
                             class="alert alert-info mb-4">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="order-timer" x-text="getOrderTimer(orderGroup.order.created_at)"></span>
                        </div>

                        <!-- Customer Info -->
                        <div x-show="orderGroup.order.customer_name" class="mb-4">
                            <div class="text-sm font-medium">Customer: <span x-text="orderGroup.order.customer_name"></span></div>
                        </div>

                        <!-- Order Items -->
                        <div class="space-y-2 mb-4">
                            <template x-for="item in orderGroup.items" :key="item.id">
                                <div class="flex justify-between items-center p-2 bg-base-100 rounded">
                                    <div class="flex-1">
                                        <span class="font-medium" x-text="item.quantity + 'x ' + item.name"></span>
                                        <div x-show="item.special_instructions"
                                             class="text-xs text-warning mt-1">
                                            üìù <span x-text="item.special_instructions"></span>
                                        </div>
                                        <div class="text-xs text-base-content/60">
                                            Prep time: <span x-text="item.preparation_time"></span> min
                                        </div>
                                    </div>
                                    <div class="ml-2">
                                        <select @change="updateItemStatus(item.id, $event.target.value)"
                                                :value="item.status"
                                                class="select select-xs select-bordered">
                                            <option value="pending">Pending</option>
                                            <option value="confirmed">Confirmed</option>
                                            <option value="preparing">Preparing</option>
                                            <option value="ready">Ready</option>
                                        </select>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Order Actions -->
                        <div class="card-actions justify-end">
                            <div class="btn-group">
                                <button x-show="orderGroup.order.status === 'pending'"
                                        @click="updateOrderStatus(orderGroup.order.id, 'confirmed')"
                                        class="btn btn-info btn-sm">
                                    Confirm Order
                                </button>
                                <button x-show="orderGroup.order.status === 'confirmed'"
                                        @click="updateOrderStatus(orderGroup.order.id, 'preparing')"
                                        class="btn btn-warning btn-sm">
                                    Start Preparing
                                </button>
                                <button x-show="orderGroup.order.status === 'preparing'"
                                        @click="updateOrderStatus(orderGroup.order.id, 'ready')"
                                        class="btn btn-success btn-sm">
                                    Mark Ready
                                </button>
                                <button x-show="orderGroup.order.status === 'ready'"
                                        @click="updateOrderStatus(orderGroup.order.id, 'delivered')"
                                        class="btn btn-neutral btn-sm">
                                    Mark Delivered
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- No Orders State -->
        <div x-show="filteredOrders.length === 0" class="text-center py-16">
            <div class="text-6xl mb-4">üìã</div>
            <h3 class="text-2xl font-bold text-base-content/70 mb-2">No Orders</h3>
            <p class="text-base-content/50" x-text="getNoOrdersMessage()"></p>
        </div>
    </div>

    <!-- Success/Error Toasts -->
    <div x-show="showToast" x-transition class="toast toast-top toast-end z-50">
        <div :class="toastType === 'success' ? 'alert-success' : 'alert-error'" class="alert">
            <span x-text="toastMessage"></span>
        </div>
    </div>
</div>

<script>
function vendorDashboard() {
    return {
        // State
        orders: [],
        connected: false,
        socket: null,
        activeFilter: 'all',
        lastUpdated: '',
        showToast: false,
        toastMessage: '',
        toastType: 'success',

        // Computed
        get ordersByStatus() {
            return {
                pending: this.orders.filter(o => o.order.status === 'pending'),
                confirmed: this.orders.filter(o => o.order.status === 'confirmed'),
                preparing: this.orders.filter(o => o.order.status === 'preparing'),
                ready: this.orders.filter(o => o.order.status === 'ready')
            };
        },

        get filteredOrders() {
            if (this.activeFilter === 'all') return this.orders;
            return this.ordersByStatus[this.activeFilter] || [];
        },

        get stats() {
            return {
                pending: this.ordersByStatus.pending.length,
                confirmed: this.ordersByStatus.confirmed.length,
                preparing: this.ordersByStatus.preparing.length,
                ready: this.ordersByStatus.ready.length
            };
        },

        init() {
            this.updateLastUpdated();
            setInterval(() => this.updateLastUpdated(), 1000);

            this.connectWebSocket();
            this.loadInitialOrders();
        },

        connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/orders/vendor/{{ vendor.id }}/`;

            this.socket = new WebSocket(wsUrl);

            this.socket.onopen = () => {
                console.log('Vendor WebSocket connected');
                this.connected = true;
            };

            this.socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                this.handleWebSocketMessage(data);
            };

            this.socket.onclose = () => {
                console.log('Vendor WebSocket disconnected');
                this.connected = false;

                // Attempt to reconnect after 3 seconds
                setTimeout(() => {
                    this.connectWebSocket();
                }, 3000);
            };

            this.socket.onerror = (error) => {
                console.error('Vendor WebSocket error:', error);
            };
        },

        handleWebSocketMessage(data) {
            switch(data.type) {
                case 'order_list':
                    this.orders = data.orders;
                    break;
                case 'new_order_for_vendor':
                    this.addNewOrder(data.order);
                    this.showToastMessage('New order received!', 'success');
                    this.playNotificationSound();
                    break;
                case 'order_update':
                    this.updateOrder(data.order);
                    break;
            }
        },

        loadInitialOrders() {
            // Load initial orders from JSON script tag
            const ordersData = document.getElementById('orders-data');
            if (ordersData) {
                this.orders = JSON.parse(ordersData.textContent);
            }
        },

        addNewOrder(newOrder) {
            // Check if order already exists
            if (!this.orders.find(o => o.order.id === newOrder.id)) {
                // Transform the order data to match expected format
                this.orders.unshift({
                    order: newOrder,
                    items: newOrder.items || []
                });
            }
        },

        updateOrder(updatedOrder) {
            const index = this.orders.findIndex(o => o.order.id === updatedOrder.id);
            if (index !== -1) {
                this.orders[index] = {
                    order: updatedOrder,
                    items: updatedOrder.items || []
                };
            }
        },

        async updateOrderStatus(orderId, newStatus) {
            try {
                const response = await fetch(`/vendors/{{ vendor.id }}/api/update-order-status/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify({
                        order_id: orderId,
                        status: newStatus
                    })
                });

                const data = await response.json();

                if (data.success) {
                    this.showToastMessage(data.message, 'success');
                    // Order will be updated via WebSocket
                } else {
                    this.showToastMessage(data.error || 'Failed to update order status', 'error');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                this.showToastMessage('Failed to update order status', 'error');
            }
        },

        async updateItemStatus(itemId, newStatus) {
            try {
                const response = await fetch(`/vendors/{{ vendor.id }}/api/update-item-status/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify({
                        item_id: itemId,
                        status: newStatus
                    })
                });

                const data = await response.json();

                if (data.success) {
                    this.showToastMessage(data.message, 'success');
                } else {
                    this.showToastMessage(data.error || 'Failed to update item status', 'error');
                }
            } catch (error) {
                console.error('Error updating item status:', error);
                this.showToastMessage('Failed to update item status', 'error');
            }
        },

        formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString();
        },

        getOrderTimer(createdAt) {
            const now = new Date();
            const created = new Date(createdAt);
            const diff = Math.floor((now - created) / 1000 / 60); // minutes

            if (diff < 60) {
                return `${diff} min ago`;
            } else {
                const hours = Math.floor(diff / 60);
                const minutes = diff % 60;
                return `${hours}h ${minutes}m ago`;
            }
        },

        updateLastUpdated() {
            this.lastUpdated = new Date().toLocaleTimeString();
        },

        getNoOrdersMessage() {
            if (this.activeFilter === 'all') {
                return 'No orders at the moment. New orders will appear here automatically.';
            }
            return `No ${this.activeFilter} orders at the moment.`;
        },

        showToastMessage(message, type = 'success') {
            this.toastMessage = message;
            this.toastType = type;
            this.showToast = true;

            setTimeout(() => {
                this.showToast = false;
            }, 3000);
        },

        playNotificationSound() {
            // Create a simple notification sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        },

        getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        }
    };
}
</script>

<!-- JSON Data -->
<script id="orders-data" type="application/json">{{ orders|safe }}</script>
{% endblock %}
