{% extends 'base.html' %} {% load static %} {% block title %}{{ vendor.name }} -
Vendor Dashboard - River Side Food Court{% endblock %} {% block extra_css %}
<style>
    .order-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
        background-color: oklch(var(--b2));
    }
    .order-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        background-color: oklch(var(--b3));
    }
    .order-pending {
        border-left-color: oklch(var(--wa));
    }
    .order-confirmed {
        border-left-color: oklch(var(--in));
    }
    .order-preparing {
        border-left-color: oklch(var(--p));
    }
    .order-ready {
        border-left-color: oklch(var(--su));
    }

    .status-badge-pending {
        @apply badge-warning;
    }
    .status-badge-confirmed {
        @apply badge-info;
    }
    .status-badge-preparing {
        @apply badge-primary;
    }
    .status-badge-ready {
        @apply badge-success;
    }

    .notification-dot {
        width: 8px;
        height: 8px;
        background: oklch(var(--er));
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .stats-card {
        background: linear-gradient(
            135deg,
            oklch(var(--p)) 0%,
            oklch(var(--p) / 0.8) 100%
        );
    }

    .preparing-pulse {
        animation: preparingPulse 2s ease-in-out infinite;
    }

    @keyframes preparingPulse {
        0%,
        100% {
            background-color: oklch(var(--p));
            transform: scale(1);
        }
        50% {
            background-color: oklch(var(--p) / 0.8);
            transform: scale(1.05);
        }
    }

    .order-timer {
        font-family: "Courier New", monospace;
        font-weight: bold;
        color: oklch(var(--bc));
    }

    .connection-indicator {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 100;
    }

    /* Dark theme specific overrides */
    .kanban-column {
        background-color: oklch(var(--b3));
        border: 1px solid oklch(var(--bc) / 0.1);
    }

    .kanban-card {
        background-color: oklch(var(--b2));
        border: 1px solid oklch(var(--bc) / 0.1);
    }

    .kanban-card:hover {
        background-color: oklch(var(--b1));
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }
</style>
{% endblock %} {% block content %}
<div
    class="min-h-screen bg-base-100 py-6"
    x-data="vendorDashboard()"
    x-init="init()"
>
    <!-- DEBUG PANEL - VISIBLE AT TOP -->
    <div class="container mx-auto px-4 mb-4">
        <div class="alert alert-info">
            <div>
                <h3 class="font-bold">Debug Info</h3>
                <div class="text-sm space-y-1">
                    <div>
                        Orders Array Length:
                        <span
                            x-text="orders.length"
                            class="font-mono bg-base-300 px-1 rounded"
                        ></span>
                    </div>
                    <div>
                        Active View:
                        <span
                            x-text="activeView"
                            class="font-mono bg-base-300 px-1 rounded"
                        ></span>
                    </div>
                    <div>
                        Active Filter:
                        <span
                            x-text="activeFilter"
                            class="font-mono bg-base-300 px-1 rounded"
                        ></span>
                    </div>
                    <div>
                        Filtered Orders:
                        <span
                            x-text="filteredOrders.length"
                            class="font-mono bg-base-300 px-1 rounded"
                        ></span>
                    </div>
                    <div>
                        Pending:
                        <span
                            x-text="ordersByStatus.pending.length"
                            class="font-mono bg-base-300 px-1 rounded"
                        ></span>
                    </div>
                    <div>
                        Confirmed:
                        <span
                            x-text="ordersByStatus.confirmed.length"
                            class="font-mono bg-base-300 px-1 rounded"
                        ></span>
                    </div>
                    <div>
                        Preparing:
                        <span
                            x-text="ordersByStatus.preparing.length"
                            class="font-mono bg-base-300 px-1 rounded"
                        ></span>
                    </div>
                    <div>
                        Ready:
                        <span
                            x-text="ordersByStatus.ready.length"
                            class="font-mono bg-base-300 px-1 rounded"
                        ></span>
                    </div>
                    <div>
                        Alpine.js Test:
                        <span
                            x-text="'Working!'"
                            class="font-mono bg-success/20 px-1 rounded text-success"
                        ></span>
                    </div>
                    <div>
                        Current Time:
                        <span
                            x-text="new Date().toLocaleTimeString()"
                            class="font-mono bg-base-300 px-1 rounded"
                        ></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4">
        <!-- Header -->
        <div
            class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8"
        >
            <div>
                <h1 class="text-3xl font-bold text-primary mb-2">
                    {{ vendor.name }}
                </h1>
                <p class="text-base-content/70">
                    {{ vendor.get_vendor_type_display }} Vendor
                </p>
            </div>
            <div class="flex gap-2 mt-4 md:mt-0">
                <a
                    href="{% url 'vendors:menu_management' vendor.id %}"
                    class="btn btn-outline btn-sm"
                >
                    <svg
                        class="w-4 h-4 mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                        ></path>
                    </svg>
                    Manage Menu
                </a>
                <a
                    href="{% url 'vendors:vendor_logout' %}"
                    class="btn btn-error btn-sm"
                >
                    <svg
                        class="w-4 h-4 mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                        ></path>
                    </svg>
                    Logout
                </a>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="stats shadow bg-base-200">
                <div class="stat place-items-center">
                    <div class="stat-title">Today Revenue</div>
                    <div class="stat-value text-success">
                        ${{ stats.today_revenue }}
                    </div>
                </div>
            </div>

            <div class="stats shadow bg-base-200">
                <div class="stat place-items-center">
                    <div class="stat-title">Pending</div>
                    <div class="stat-value text-warning">
                        {{ stats.pending_orders }}
                    </div>
                </div>
            </div>

            <div class="stats shadow bg-base-200">
                <div class="stat place-items-center">
                    <div class="stat-title">Preparing</div>
                    <div class="stat-value text-primary">
                        {{ stats.preparing_orders }}
                    </div>
                </div>
            </div>

            <div class="stats shadow bg-base-200">
                <div class="stat place-items-center">
                    <div class="stat-title">Ready</div>
                    <div class="stat-value text-success">
                        {{ stats.ready_orders }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Filter Tabs -->
        <div class="flex flex-col lg:flex-row gap-4 mb-6">
            <!-- Order Status Tabs -->
            <div class="tabs tabs-boxed bg-base-200 flex-1">
                <button
                    @click="activeFilter = 'all'"
                    :class="activeFilter === 'all' ? 'tab-active' : ''"
                    class="tab"
                >
                    All Orders (<span x-text="orders.length"></span>)
                </button>
                <button
                    @click="activeFilter = 'pending'"
                    :class="activeFilter === 'pending' ? 'tab-active' : ''"
                    class="tab"
                >
                    Pending (<span
                        x-text="orders.filter(o => o.order.status === 'pending').length"
                    ></span
                    >)
                </button>
                <button
                    @click="activeFilter = 'preparing'"
                    :class="activeFilter === 'preparing' ? 'tab-active' : ''"
                    class="tab"
                >
                    Preparing (<span
                        x-text="orders.filter(o => o.order.status === 'preparing').length"
                    ></span
                    >)
                </button>
                <button
                    @click="activeFilter = 'ready'"
                    :class="activeFilter === 'ready' ? 'tab-active' : ''"
                    class="tab"
                >
                    Ready (<span
                        x-text="orders.filter(o => o.order.status === 'ready').length"
                    ></span
                    >)
                </button>
                <button
                    @click="activeFilter = 'delivered'"
                    :class="activeFilter === 'delivered' ? 'tab-active' : ''"
                    class="tab"
                >
                    Delivered (<span
                        x-text="orders.filter(o => o.order.status === 'delivered').length"
                    ></span
                    >)
                </button>
            </div>

            <!-- Payment Status Tabs -->
            <div class="tabs tabs-boxed bg-base-300">
                <button
                    @click="activeView = 'current'"
                    :class="activeView === 'current' ? 'tab-active' : ''"
                    class="tab"
                >
                    <svg
                        class="w-4 h-4 mr-1"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                        ></path>
                    </svg>
                    Current Orders
                </button>
                <button
                    @click="activeView = 'paid'"
                    :class="activeView === 'paid' ? 'tab-active' : ''"
                    class="tab"
                >
                    <svg
                        class="w-4 h-4 mr-1"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"
                        ></path>
                    </svg>
                    Paid Orders ({{ stats.total_paid_orders }})
                </button>
            </div>
        </div>

        <!-- Debug Info Panel -->
        <div class="mb-4 p-4 bg-base-200 rounded-lg">
            <h3 class="font-bold mb-2">Debug Info:</h3>
            <div class="text-sm space-y-1">
                <div>
                    Total Orders:
                    <span x-text="orders.length" class="font-mono"></span>
                </div>
                <div>
                    Active View:
                    <span x-text="activeView" class="font-mono"></span>
                </div>
                <div>
                    Pending:
                    <span
                        x-text="orders.filter(o => o.order.status === 'pending').length"
                        class="font-mono"
                    ></span>
                </div>
                <div>
                    Confirmed:
                    <span
                        x-text="orders.filter(o => o.order.status === 'confirmed').length"
                        class="font-mono"
                    ></span>
                </div>
                <div>
                    Preparing:
                    <span
                        x-text="orders.filter(o => o.order.status === 'preparing').length"
                        class="font-mono"
                    ></span>
                </div>
            </div>
        </div>

        <!-- Simple Orders List for Testing -->
        <div x-show="activeView === 'current'" class="space-y-4">
            <h3 class="text-xl font-bold">
                All Orders (Count: <span x-text="orders.length"></span>)
            </h3>

            <!-- Show message if no orders -->
            <div x-show="orders.length === 0" class="alert alert-warning">
                <div>
                    <h4 class="font-bold">No Orders Found</h4>
                    <p>
                        The orders array is empty. Check console for loading
                        errors.
                    </p>
                </div>
            </div>

            <!-- Show orders if they exist -->
            <div x-show="orders.length > 0" class="space-y-4">
                <div class="alert alert-success">
                    <div>
                        Found <span x-text="orders.length"></span> orders.
                        Displaying below:
                    </div>
                </div>
            </div>

            <template x-for="orderGroup in orders" :key="orderGroup.order.id">
                <div class="bg-base-200 p-4 rounded-lg">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="font-bold"
                                >Table
                                <span
                                    x-text="orderGroup.order.table_number"
                                ></span
                            ></span>
                            <span
                                class="badge badge-sm ml-2"
                                :class="'badge-' + orderGroup.order.status"
                                x-text="orderGroup.order.status.toUpperCase()"
                            ></span>
                        </div>
                        <div class="text-lg font-bold">
                            $<span
                                x-text="parseFloat(orderGroup.order.total_amount).toFixed(2)"
                            ></span>
                        </div>
                    </div>
                    <div class="mb-2">
                        <template
                            x-for="item in orderGroup.items"
                            :key="item.id"
                        >
                            <div class="text-sm">
                                <span
                                    x-text="item.quantity + 'x ' + item.name"
                                ></span>
                            </div>
                        </template>
                    </div>
                    <div class="flex gap-2">
                        <button
                            @click="updateOrderStatus(orderGroup.order.id, 'confirmed')"
                            x-show="orderGroup.order.status === 'pending'"
                            class="btn btn-sm btn-info"
                        >
                            Accept
                        </button>
                        <button
                            @click="updateOrderStatus(orderGroup.order.id, 'preparing')"
                            x-show="orderGroup.order.status === 'confirmed'"
                            class="btn btn-sm btn-warning"
                        >
                            Start Cooking
                        </button>
                        <button
                            @click="updateOrderStatus(orderGroup.order.id, 'ready')"
                            x-show="orderGroup.order.status === 'preparing'"
                            class="btn btn-sm btn-success"
                        >
                            Mark Ready
                        </button>
                        <button
                            @click="updateOrderStatus(orderGroup.order.id, 'delivered')"
                            x-show="orderGroup.order.status === 'ready'"
                            class="btn btn-sm btn-neutral"
                        >
                            Mark Delivered
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <!-- Kanban Board Style Order Management (Hidden for now) -->
        <div x-show="false" class="grid grid-cols-1 lg:grid-cols-4 gap-4">
            <!-- Pending Column -->
            <div class="kanban-column rounded-lg p-4">
                <div class="flex items-center mb-4">
                    <div class="w-3 h-3 bg-warning rounded-full mr-2"></div>
                    <h3 class="font-bold text-warning">Pending</h3>
                    <span
                        class="ml-2 badge badge-sm badge-warning"
                        x-text="orders.filter(o => o.order.status === 'pending').length"
                    ></span>
                </div>
                <div class="space-y-3">
                    <template
                        x-for="orderGroup in orders.filter(o => o.order.status === 'pending')"
                        :key="orderGroup.order.id"
                    >
                        <div
                            class="kanban-card rounded-lg shadow-sm border-l-4 border-warning p-4 hover:shadow-md transition-all"
                        >
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-semibold text-base-content">
                                    Table
                                    <span
                                        x-text="orderGroup.order.table_number"
                                    ></span>
                                    <div
                                        class="badge badge-warning badge-sm mt-1"
                                    >
                                        PENDING
                                    </div>
                                </div>
                                <div class="text-lg font-bold text-warning">
                                    $<span
                                        x-text="parseFloat(orderGroup.order.total_amount).toFixed(2)"
                                    ></span>
                                </div>
                            </div>
                            <div class="text-xs text-base-content/60 mb-2">
                                <span
                                    x-text="formatTime(orderGroup.order.created_at)"
                                ></span>
                            </div>
                            <div
                                class="text-xs text-base-content/80 mb-3"
                                x-show="orderGroup.order.customer_name"
                            >
                                üë§
                                <span
                                    x-text="orderGroup.order.customer_name"
                                ></span>
                            </div>

                            <!-- Order Items -->
                            <div class="mb-4">
                                <div class="text-xs text-base-content/70 mb-2">
                                    ORDER ITEMS:
                                </div>
                                <div class="space-y-2">
                                    <template
                                        x-for="item in orderGroup.items"
                                        :key="item.id"
                                    >
                                        <div
                                            class="bg-base-300 p-2 rounded border-l-2 border-warning"
                                        >
                                            <div
                                                class="flex justify-between items-start"
                                            >
                                                <div
                                                    class="font-medium text-sm text-base-content"
                                                >
                                                    <span
                                                        x-text="item.quantity"
                                                    ></span
                                                    >x
                                                    <span
                                                        x-text="item.name"
                                                    ></span>
                                                </div>
                                                <div
                                                    class="text-xs text-base-content/60"
                                                    x-show="item.preparation_time"
                                                >
                                                    <span
                                                        x-text="item.preparation_time"
                                                    ></span
                                                    >min
                                                </div>
                                            </div>
                                            <div
                                                x-show="item.special_instructions"
                                                class="text-xs text-warning mt-1 bg-warning/10 p-1 rounded"
                                            >
                                                üìù
                                                <span
                                                    x-text="item.special_instructions"
                                                ></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button
                                    @click="updateOrderStatus(orderGroup.order.id, 'confirmed')"
                                    class="btn btn-info btn-sm flex-1"
                                >
                                    ‚úì Accept
                                </button>
                                <button
                                    @click="updateOrderStatus(orderGroup.order.id, 'cancelled')"
                                    class="btn btn-error btn-sm px-2"
                                >
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Confirmed Column -->
            <div class="kanban-column rounded-lg p-4">
                <div class="flex items-center mb-4">
                    <div class="w-3 h-3 bg-info rounded-full mr-2"></div>
                    <h3 class="font-bold text-info">Confirmed</h3>
                    <span
                        class="ml-2 badge badge-sm badge-info"
                        x-text="orders.filter(o => o.order.status === 'confirmed').length"
                    ></span>
                </div>
                <div class="space-y-3">
                    <template
                        x-for="orderGroup in orders.filter(o => o.order.status === 'confirmed')"
                        :key="orderGroup.order.id"
                    >
                        <div
                            class="kanban-card rounded-lg shadow-sm border-l-4 border-info p-4 hover:shadow-md transition-all"
                        >
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-semibold text-base-content">
                                    Table
                                    <span
                                        x-text="orderGroup.order.table_number"
                                    ></span>
                                    <div class="badge badge-info badge-sm mt-1">
                                        CONFIRMED
                                    </div>
                                </div>
                                <div class="text-lg font-bold text-info">
                                    $<span
                                        x-text="parseFloat(orderGroup.order.total_amount).toFixed(2)"
                                    ></span>
                                </div>
                            </div>
                            <div class="text-xs text-base-content/60 mb-2">
                                <span
                                    x-text="formatTime(orderGroup.order.created_at)"
                                ></span>
                            </div>
                            <div
                                class="text-xs text-base-content/80 mb-3"
                                x-show="orderGroup.order.customer_name"
                            >
                                üë§
                                <span
                                    x-text="orderGroup.order.customer_name"
                                ></span>
                            </div>

                            <!-- Order Items -->
                            <div class="mb-4">
                                <div class="text-xs text-base-content/70 mb-2">
                                    ORDER ITEMS:
                                </div>
                                <div class="space-y-2">
                                    <template
                                        x-for="item in orderGroup.items"
                                        :key="item.id"
                                    >
                                        <div
                                            class="bg-base-300 p-2 rounded border-l-2 border-info"
                                        >
                                            <div
                                                class="flex justify-between items-start"
                                            >
                                                <div
                                                    class="font-medium text-sm text-base-content"
                                                >
                                                    <span
                                                        x-text="item.quantity"
                                                    ></span
                                                    >x
                                                    <span
                                                        x-text="item.name"
                                                    ></span>
                                                </div>
                                                <div
                                                    class="text-xs text-base-content/60"
                                                    x-show="item.preparation_time"
                                                >
                                                    <span
                                                        x-text="item.preparation_time"
                                                    ></span
                                                    >min
                                                </div>
                                            </div>
                                            <div
                                                x-show="item.special_instructions"
                                                class="text-xs text-info mt-1 bg-info/10 p-1 rounded"
                                            >
                                                üìù
                                                <span
                                                    x-text="item.special_instructions"
                                                ></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button
                                    @click="updateOrderStatus(orderGroup.order.id, 'preparing')"
                                    class="btn btn-warning btn-sm flex-1"
                                >
                                    üç≥ Start Cooking
                                </button>
                                <button
                                    @click="updateOrderStatus(orderGroup.order.id, 'cancelled')"
                                    class="btn btn-error btn-sm px-2"
                                >
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Preparing Column -->
            <div class="kanban-column rounded-lg p-4">
                <div class="flex items-center mb-4">
                    <div
                        class="w-3 h-3 bg-primary rounded-full mr-2 animate-pulse"
                    ></div>
                    <h3 class="font-bold text-primary">Preparing</h3>
                    <span
                        class="ml-2 badge badge-sm badge-primary"
                        x-text="orders.filter(o => o.order.status === 'preparing').length"
                    ></span>
                </div>
                <div class="space-y-3">
                    <template
                        x-for="orderGroup in orders.filter(o => o.order.status === 'preparing')"
                        :key="orderGroup.order.id"
                    >
                        <div
                            class="kanban-card rounded-lg shadow-sm border-l-4 border-primary p-4 hover:shadow-md transition-all"
                        >
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-semibold text-base-content">
                                    Table
                                    <span
                                        x-text="orderGroup.order.table_number"
                                    ></span>
                                    <div
                                        class="badge badge-primary badge-sm mt-1"
                                    >
                                        PREPARING
                                    </div>
                                </div>
                                <div class="text-lg font-bold text-primary">
                                    $<span
                                        x-text="parseFloat(orderGroup.order.total_amount).toFixed(2)"
                                    ></span>
                                </div>
                            </div>
                            <div class="text-xs text-base-content/60 mb-2">
                                <span
                                    x-text="formatTime(orderGroup.order.created_at)"
                                ></span>
                            </div>
                            <div
                                class="text-xs text-base-content/80 mb-2"
                                x-show="orderGroup.order.customer_name"
                            >
                                üë§
                                <span
                                    x-text="orderGroup.order.customer_name"
                                ></span>
                            </div>
                            <div class="text-xs text-primary mb-3 font-medium">
                                ‚è±Ô∏è
                                <span
                                    x-text="getOrderTimer(orderGroup.order.created_at)"
                                ></span>
                            </div>

                            <!-- Order Items -->
                            <div class="mb-4">
                                <div class="text-xs text-base-content/70 mb-2">
                                    PREPARING:
                                </div>
                                <div class="space-y-2">
                                    <template
                                        x-for="item in orderGroup.items"
                                        :key="item.id"
                                    >
                                        <div
                                            class="bg-base-300 p-2 rounded border-l-2 border-primary"
                                        >
                                            <div
                                                class="flex justify-between items-start"
                                            >
                                                <div
                                                    class="font-medium text-sm text-base-content"
                                                >
                                                    <span
                                                        x-text="item.quantity"
                                                    ></span
                                                    >x
                                                    <span
                                                        x-text="item.name"
                                                    ></span>
                                                </div>
                                                <div
                                                    class="text-xs text-primary font-bold"
                                                >
                                                    <span
                                                        x-text="item.preparation_time"
                                                    ></span
                                                    >min
                                                </div>
                                            </div>
                                            <div
                                                x-show="item.special_instructions"
                                                class="text-xs text-warning mt-1 bg-warning/20 p-1 rounded font-medium"
                                            >
                                                üìù
                                                <span
                                                    x-text="item.special_instructions"
                                                ></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button
                                    @click="updateOrderStatus(orderGroup.order.id, 'ready')"
                                    class="btn btn-success btn-sm flex-1"
                                >
                                    ‚úÖ Mark Ready
                                </button>
                                <button
                                    @click="updateOrderStatus(orderGroup.order.id, 'cancelled')"
                                    class="btn btn-error btn-sm px-2"
                                >
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Ready/Delivered Column -->
            <div class="kanban-column rounded-lg p-4">
                <div class="flex items-center mb-4">
                    <div class="w-3 h-3 bg-success rounded-full mr-2"></div>
                    <h3 class="font-bold text-success">Ready & Delivered</h3>
                    <span
                        class="ml-2 badge badge-sm badge-success"
                        x-text="orders.filter(o => ['ready', 'delivered'].includes(o.order.status)).length"
                    ></span>
                </div>
                <div class="space-y-3">
                    <template
                        x-for="orderGroup in orders.filter(o => ['ready', 'delivered'].includes(o.order.status))"
                        :key="orderGroup.order.id"
                    >
                        <div
                            class="kanban-card rounded-lg shadow-sm border-l-4 p-4 hover:shadow-md transition-all"
                            :class="orderGroup.order.status === 'ready' ? 'border-success' : 'border-accent'"
                        >
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-semibold text-base-content">
                                    Table
                                    <span
                                        x-text="orderGroup.order.table_number"
                                    ></span>
                                    <div
                                        class="badge badge-sm mt-1"
                                        :class="orderGroup.order.status === 'ready' ? 'badge-success' : 'badge-accent'"
                                        x-text="orderGroup.order.status.toUpperCase()"
                                    ></div>
                                </div>
                                <div
                                    class="text-lg font-bold"
                                    :class="orderGroup.order.status === 'ready' ? 'text-success' : 'text-accent'"
                                >
                                    $<span
                                        x-text="parseFloat(orderGroup.order.total_amount).toFixed(2)"
                                    ></span>
                                </div>
                            </div>
                            <div class="text-xs mb-2 text-base-content/60">
                                <span
                                    x-text="formatTime(orderGroup.order.created_at)"
                                ></span>
                            </div>
                            <div
                                class="text-xs text-base-content/80 mb-2"
                                x-show="orderGroup.order.customer_name"
                            >
                                üë§
                                <span
                                    x-text="orderGroup.order.customer_name"
                                ></span>
                            </div>
                            <div
                                class="text-xs font-medium mb-3"
                                :class="orderGroup.order.status === 'ready' ? 'text-success' : 'text-accent'"
                            >
                                <span
                                    x-show="orderGroup.order.status === 'ready'"
                                    >üîî Ready for pickup</span
                                >
                                <span
                                    x-show="orderGroup.order.status === 'delivered'"
                                    >üì¶ Delivered</span
                                >
                            </div>
                            <!-- Order Items -->
                            <div class="mb-4">
                                <div class="text-xs text-base-content/70 mb-2">
                                    ORDER COMPLETED:
                                </div>
                                <div class="space-y-2">
                                    <template
                                        x-for="item in orderGroup.items"
                                        :key="item.id"
                                    >
                                        <div
                                            class="bg-base-300 p-2 rounded border-l-2 border-success"
                                        >
                                            <div
                                                class="font-medium text-sm text-base-content"
                                            >
                                                <span
                                                    x-text="item.quantity"
                                                ></span
                                                >x
                                                <span x-text="item.name"></span>
                                            </div>
                                            <div
                                                x-show="item.special_instructions"
                                                class="text-xs text-success mt-1 bg-success/10 p-1 rounded"
                                            >
                                                üìù
                                                <span
                                                    x-text="item.special_instructions"
                                                ></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <div
                                x-show="orderGroup.order.status === 'ready'"
                                class="flex gap-2"
                            >
                                <button
                                    @click="updateOrderStatus(orderGroup.order.id, 'delivered')"
                                    class="btn btn-neutral btn-sm flex-1"
                                >
                                    üì¶ Mark Delivered
                                </button>
                                <button
                                    @click="updateOrderStatus(orderGroup.order.id, 'cancelled')"
                                    class="btn btn-error btn-sm px-2"
                                >
                                    ‚úï
                                </button>
                            </div>
                            <div
                                x-show="orderGroup.order.status === 'delivered'"
                                class="text-center text-sm text-accent font-medium"
                            >
                                ‚úì Complete - Ready for Payment
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Paid Orders Grid -->
        <div x-show="activeView === 'paid'" class="space-y-4">
            {% for order_group in paid_orders %}
            <div class="card bg-base-200 border border-success/30 shadow-lg">
                <div class="card-body">
                    <!-- Paid Order Header -->
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="card-title text-lg text-success">
                                Table {{ order_group.order.table_number }}
                            </h3>
                            <div class="text-sm text-base-content/80">
                                Order #{{ order_group.order.id|slice:":8" }}
                            </div>
                            <div class="text-xs text-base-content/60">
                                Paid: {{ order_group.order.paid_at|date:"M d,
                                H:i" }}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-success">
                                ${{ order_group.vendor_total|floatformat:2 }}
                            </div>
                            <div class="badge badge-success">PAID</div>
                        </div>
                    </div>

                    <!-- Customer Info -->
                    {% if order_group.order.customer_name %}
                    <div class="mb-3">
                        <div class="text-sm font-medium text-base-content">
                            Customer: {{ order_group.order.customer_name }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Paid Order Items -->
                    <div class="space-y-2">
                        {% for item in order_group.items %}
                        <div
                            class="flex justify-between items-center bg-base-300 p-3 rounded border border-base-content/10"
                        >
                            <div class="flex-1">
                                <span class="font-medium text-base-content"
                                    >{{ item.quantity }}x {{ item.name }}</span
                                >
                                {% if item.special_instructions %}
                                <div class="text-sm text-base-content/70 mt-1">
                                    Note: {{ item.special_instructions }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-success">
                                    ${{ item.subtotal }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Payment Details -->
                    {% if order_group.order.notes %}
                    <div
                        class="mt-4 p-3 bg-base-300 rounded border border-base-content/10"
                    >
                        <div class="text-sm text-base-content/80">
                            <strong>Payment Notes:</strong> {{
                            order_group.order.notes|linebreaks }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="text-center py-16">
                <div class="text-6xl mb-4">üí∞</div>
                <h3 class="text-2xl font-bold text-success mb-2">
                    No Paid Orders
                </h3>
                <p class="text-base-content/70">
                    No orders have been paid yet.
                </p>
            </div>
            {% endfor %}
        </div>

        <!-- No Current Orders State -->
        <div
            x-show="activeView === 'current' && filteredOrders.length === 0"
            class="text-center py-16"
        >
            <div class="text-6xl mb-4">üìã</div>
            <h3 class="text-2xl font-bold text-base-content mb-2">No Orders</h3>
            <p class="text-base-content/70" x-text="getNoOrdersMessage()"></p>
        </div>
    </div>

    <!-- Success/Error Toasts -->
    <div x-show="showToast" x-transition class="toast toast-top toast-end z-50">
        <div
            :class="toastType === 'success' ? 'alert-success' : 'alert-error'"
            class="alert"
        >
            <span x-text="toastMessage"></span>
        </div>
    </div>
</div>

<script>
    function vendorDashboard() {
        return {
            // State
            orders: [],
            connected: false,
            activeView: "current",
            socket: null,
            activeFilter: "all",
            lastUpdated: "",
            showToast: false,
            toastMessage: "",
            toastType: "success",

            // Computed
            get ordersByStatus() {
                return {
                    pending: this.orders.filter(
                        (o) => o.order.status === "pending",
                    ),
                    confirmed: this.orders.filter(
                        (o) => o.order.status === "confirmed",
                    ),
                    preparing: this.orders.filter(
                        (o) => o.order.status === "preparing",
                    ),
                    ready: this.orders.filter(
                        (o) => o.order.status === "ready",
                    ),
                };
            },

            get filteredOrders() {
                console.log(
                    "Filtering orders with activeFilter:",
                    this.activeFilter,
                );
                if (this.activeFilter === "all") {
                    console.log("Returning all orders:", this.orders.length);
                    return this.orders;
                }
                const filtered = this.ordersByStatus[this.activeFilter] || [];
                console.log(
                    `Filtered ${this.activeFilter} orders:`,
                    filtered.length,
                );
                return filtered;
            },

            get stats() {
                return {
                    pending: this.ordersByStatus.pending.length,
                    confirmed: this.ordersByStatus.confirmed.length,
                    preparing: this.ordersByStatus.preparing.length,
                    ready: this.ordersByStatus.ready.length,
                };
            },

            init() {
                console.log("Initializing vendor dashboard...");
                this.loadInitialOrders();
                console.log("Orders after loading:", this.orders);
                this.updateLastUpdated();
                setInterval(() => this.updateLastUpdated(), 1000);
                this.connectWebSocket();

                // Debug interval to check orders state
                setInterval(() => {
                    console.log("Orders check:", {
                        total: this.orders.length,
                        pending: this.orders.filter(
                            (o) => o.order.status === "pending",
                        ).length,
                        confirmed: this.orders.filter(
                            (o) => o.order.status === "confirmed",
                        ).length,
                        preparing: this.orders.filter(
                            (o) => o.order.status === "preparing",
                        ).length,
                        ready: this.orders.filter(
                            (o) => o.order.status === "ready",
                        ).length,
                    });
                }, 5000);
            },

            connectWebSocket() {
                const protocol =
                    window.location.protocol === "https:" ? "wss:" : "ws:";
                const wsUrl = `${protocol}//${window.location.host}/ws/orders/vendor/{{ vendor.id }}/`;

                this.socket = new WebSocket(wsUrl);

                this.socket.onopen = () => {
                    console.log("Vendor WebSocket connected");
                    this.connected = true;
                };

                this.socket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };

                this.socket.onclose = () => {
                    console.log("Vendor WebSocket disconnected");
                    this.connected = false;

                    // Attempt to reconnect after 3 seconds
                    setTimeout(() => {
                        this.connectWebSocket();
                    }, 3000);
                };

                this.socket.onerror = (error) => {
                    console.error("Vendor WebSocket error:", error);
                };
            },

            handleWebSocketMessage(data) {
                switch (data.type) {
                    case "order_list":
                        this.orders = data.orders;
                        break;
                    case "new_order_for_vendor":
                        this.addNewOrder(data.order);
                        this.showToastMessage("New order received!", "success");
                        this.playNotificationSound();
                        break;
                    case "order_update":
                        this.updateOrder(data.order);
                        break;
                }
            },

            loadInitialOrders() {
                // Load initial orders from JSON script tag
                const ordersData = document.getElementById("orders-data");
                if (ordersData) {
                    try {
                        const jsonData = ordersData.textContent.trim();
                        console.log(
                            "Raw JSON data:",
                            jsonData.substring(0, 200) + "...",
                        );
                        this.orders = JSON.parse(jsonData);
                        console.log(
                            "Parsed orders successfully:",
                            this.orders.length,
                            "orders",
                        );
                        console.log("First order:", this.orders[0]);

                        // Validate order structure
                        this.orders.forEach((orderGroup, index) => {
                            if (!orderGroup.order || !orderGroup.items) {
                                console.error(
                                    `Invalid order structure at index ${index}:`,
                                    orderGroup,
                                );
                            }
                        });
                    } catch (e) {
                        console.error("Error parsing orders data:", e);
                        console.error("Raw data that failed:", jsonData);
                        this.orders = [];
                    }
                } else {
                    console.warn("No orders-data element found");
                    this.orders = [];
                }
            },

            addNewOrder(newOrder) {
                // Check if order already exists
                if (!this.orders.find((o) => o.order.id === newOrder.id)) {
                    // Transform the order data to match expected format
                    this.orders.unshift({
                        order: newOrder,
                        items: newOrder.items || [],
                    });
                }
            },

            updateOrder(updatedOrder) {
                const index = this.orders.findIndex(
                    (o) => o.order.id === updatedOrder.id,
                );
                if (index !== -1) {
                    this.orders[index] = {
                        order: updatedOrder,
                        items: updatedOrder.items || [],
                    };
                }
            },

            async updateOrderStatus(orderId, newStatus) {
                try {
                    const response = await fetch(
                        `/vendors/{{ vendor.id }}/api/update-order-status/`,
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": this.getCsrfToken(),
                            },
                            body: JSON.stringify({
                                order_id: orderId,
                                status: newStatus,
                            }),
                        },
                    );

                    const data = await response.json();

                    if (data.success) {
                        this.showToastMessage(data.message, "success");
                        // Immediately update the local order status for better UX
                        const orderIndex = this.orders.findIndex(
                            (o) => o.order.id === orderId,
                        );
                        if (orderIndex !== -1) {
                            this.orders[orderIndex].order.status = newStatus;
                        }
                        // Order will also be updated via WebSocket
                    } else {
                        this.showToastMessage(
                            data.error || "Failed to update order status",
                            "error",
                        );
                    }
                } catch (error) {
                    console.error("Error updating order status:", error);
                    this.showToastMessage(
                        "Failed to update order status",
                        "error",
                    );
                }
            },

            async updateItemStatus(itemId, newStatus) {
                try {
                    const response = await fetch(
                        `/vendors/{{ vendor.id }}/api/update-item-status/`,
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": this.getCsrfToken(),
                            },
                            body: JSON.stringify({
                                item_id: itemId,
                                status: newStatus,
                            }),
                        },
                    );

                    const data = await response.json();

                    if (data.success) {
                        this.showToastMessage(data.message, "success");
                    } else {
                        this.showToastMessage(
                            data.error || "Failed to update item status",
                            "error",
                        );
                    }
                } catch (error) {
                    console.error("Error updating item status:", error);
                    this.showToastMessage(
                        "Failed to update item status",
                        "error",
                    );
                }
            },

            formatTime(timestamp) {
                return new Date(timestamp).toLocaleTimeString();
            },

            getOrderTimer(createdAt) {
                const now = new Date();
                const created = new Date(createdAt);
                const diff = Math.floor((now - created) / 1000 / 60); // minutes

                if (diff < 60) {
                    return `${diff} min ago`;
                } else {
                    const hours = Math.floor(diff / 60);
                    const minutes = diff % 60;
                    return `${hours}h ${minutes}m ago`;
                }
            },

            updateLastUpdated() {
                this.lastUpdated = new Date().toLocaleTimeString();
            },

            getNoOrdersMessage() {
                if (this.activeFilter === "all") {
                    return "No orders at the moment. New orders will appear here automatically.";
                }
                return `No ${this.activeFilter} orders at the moment.`;
            },

            showToastMessage(message, type = "success") {
                this.toastMessage = message;
                this.toastType = type;
                this.showToast = true;

                setTimeout(() => {
                    this.showToast = false;
                }, 3000);
            },

            playNotificationSound() {
                // Create a simple notification sound
                const audioContext = new (window.AudioContext ||
                    window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = "sine";

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(
                    0.01,
                    audioContext.currentTime + 0.5,
                );

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            },

            getCsrfToken() {
                const token =
                    document.querySelector("[name=csrfmiddlewaretoken]")
                        ?.value ||
                    document
                        .querySelector('meta[name="csrf-token"]')
                        ?.getAttribute("content") ||
                    "";
                return token;
            },
        };
    }
</script>

<!-- CSRF Token -->
<meta name="csrf-token" content="{{ csrf_token }}" />

<!-- JSON Data -->
<script id="orders-data" type="application/json">
    {{ orders|safe }}
</script>

<!-- Debug Info -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("=== Vendor Dashboard Debug Info ===");
        console.log("Vendor ID: {{ vendor.id }}");
        console.log(
            "Orders data element exists:",
            !!document.getElementById("orders-data"),
        );

        const ordersElement = document.getElementById("orders-data");
        if (ordersElement) {
            const rawData = ordersElement.textContent;
            console.log("Raw orders data length:", rawData.length);
            console.log("Raw orders data preview:", rawData.substring(0, 500));

            try {
                const parsed = JSON.parse(rawData);
                console.log(
                    "Successfully parsed JSON with",
                    parsed.length,
                    "orders",
                );
                console.log("First order structure:", parsed[0]);
            } catch (e) {
                console.error("Failed to parse JSON:", e);
            }
        }

        // Check Alpine.js
        console.log("Alpine.js available:", typeof Alpine !== "undefined");

        // Check if page has loaded completely
        setTimeout(() => {
            const dashboard = document.querySelector(
                '[x-data="vendorDashboard()"]',
            );
            console.log("Dashboard element found:", !!dashboard);
            if (dashboard && dashboard._x_dataStack) {
                console.log(
                    "Alpine data initialized:",
                    dashboard._x_dataStack[0],
                );
            }
        }, 1000);
    });
</script>
{% endblock %}
