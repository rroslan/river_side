{% extends 'base.html' %}
{% load static %}

{% block title %}Menu Management - {{ vendor.name }} - River Side Food Court{% endblock %}

{% block content %}
<div class="min-h-screen bg-base-100 py-8" x-data="menuManagement()">
    <div class="container mx-auto px-4">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
            <div>
                <div class="flex items-center mb-2">
                    <a href="{% url 'vendors:vendor_list' %}" class="btn btn-ghost btn-sm mr-2">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Back
                    </a>
                    <h1 class="text-3xl font-bold text-primary">Menu Management</h1>
                </div>
                <p class="text-base-content/70">{{ vendor.name }} - {{ vendor.get_vendor_type_display }}</p>
            </div>

            <div class="flex gap-2 mt-4 md:mt-0">
                <a href="{% url 'vendors:vendor_dashboard' vendor.id %}" class="btn btn-outline btn-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2-2V7a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 002 2h2a2 2 0 012-2V7a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 00-2 2h-2a2 2 0 00-2 2v6a2 2 0 01-2 2H7a2 2 0 01-2-2z"></path>
                    </svg>
                    Dashboard
                </a>
                {% if user.is_staff %}
                <a href="/admin/vendors/vendor/{{ vendor.id }}/change/" class="btn btn-primary btn-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Edit Vendor Info
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Vendor Info Card -->
        <div class="card bg-base-200 shadow-lg mb-8">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        {% if vendor.logo %}
                        <img src="{{ vendor.logo.url }}" alt="{{ vendor.name }}" class="w-16 h-16 rounded-full mr-4">
                        {% else %}
                        <div class="w-16 h-16 rounded-full bg-primary flex items-center justify-center mr-4">
                            {% if vendor.vendor_type == 'drinks' %}
                            <span class="text-3xl">ü•§</span>
                            {% else %}
                            <span class="text-3xl">üçΩÔ∏è</span>
                            {% endif %}
                        </div>
                        {% endif %}
                        <div>
                            <h2 class="text-2xl font-bold">{{ vendor.name }}</h2>
                            <div class="flex items-center gap-2">
                                <div class="badge badge-outline">{{ vendor.get_vendor_type_display }}</div>
                                {% if vendor.is_active %}
                                <div class="badge badge-success">Active</div>
                                {% else %}
                                <div class="badge badge-error">Inactive</div>
                                {% endif %}
                            </div>
                            {% if vendor.opening_time and vendor.closing_time %}
                            <p class="text-sm text-base-content/60 mt-1">
                                Hours: {{ vendor.opening_time|time:"g:i A" }} - {{ vendor.closing_time|time:"g:i A" }}
                            </p>
                            {% endif %}
                        </div>
                    </div>

                    {% if user.is_staff %}
                    <div class="text-right">
                        <p class="text-sm text-base-content/60">Update logo & vendor info in</p>
                        <a href="/admin/vendors/vendor/{{ vendor.id }}/change/" class="link link-primary">Admin Panel</a>
                    </div>
                    {% endif %}
                </div>

                {% if vendor.description %}
                <p class="mt-4 text-base-content/80">{{ vendor.description }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Menu Categories -->
        {% if categories %}
        <div class="space-y-8">
            {% for category in categories %}
            <div class="card bg-base-200 shadow-lg">
                <div class="card-body">
                    <!-- Category Header -->
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-xl font-bold">{{ category.name }}</h3>
                            {% if category.description %}
                            <p class="text-base-content/70">{{ category.description }}</p>
                            {% endif %}
                        </div>

                        {% if user.is_staff %}
                        <div class="flex gap-2">
                            <a href="/admin/vendors/category/{{ category.id }}/change/" class="btn btn-outline btn-sm">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                Edit Category
                            </a>
                            <a href="/admin/vendors/menuitem/add/?category={{ category.id }}" class="btn btn-primary btn-sm">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Add Item
                            </a>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Menu Items Grid -->
                    {% if category.menu_items.all %}
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% for item in category.menu_items.all %}
                        <div class="card bg-base-100 shadow-md hover:shadow-lg transition-shadow duration-200">
                            {% if item.image %}
                            <figure class="px-4 pt-4">
                                <img src="{{ item.image.url }}" alt="{{ item.name }}" class="rounded-lg w-full h-32 object-cover">
                            </figure>
                            {% endif %}

                            <div class="card-body p-4">
                                <!-- Item Header -->
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-lg">{{ item.name }}</h4>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-primary">${{ item.price }}</div>
                                        <div class="text-xs text-base-content/60">{{ item.preparation_time }}min</div>
                                    </div>
                                </div>

                                <!-- Description -->
                                {% if item.description %}
                                <p class="text-sm text-base-content/70 mb-3">{{ item.description|truncatechars:100 }}</p>
                                {% endif %}

                                <!-- Dietary & Status Badges -->
                                <div class="flex flex-wrap gap-1 mb-3">
                                    {% if item.is_vegetarian %}
                                    <div class="badge badge-success badge-sm">üå± Vegetarian</div>
                                    {% endif %}
                                    {% if item.is_vegan %}
                                    <div class="badge badge-success badge-sm">üåø Vegan</div>
                                    {% endif %}
                                    {% if item.is_spicy %}
                                    <div class="badge badge-warning badge-sm">üå∂Ô∏è Spicy</div>
                                    {% endif %}
                                    {% if item.calories %}
                                    <div class="badge badge-outline badge-sm">{{ item.calories }} cal</div>
                                    {% endif %}
                                </div>

                                <!-- Actions -->
                                <div class="flex justify-between items-center">
                                    <!-- Availability Toggle -->
                                    <div class="form-control">
                                        <label class="label cursor-pointer">
                                            <span class="label-text mr-2 text-sm">Available</span>
                                            <input
                                                type="checkbox"
                                                class="toggle toggle-primary toggle-sm"
                                                :checked="getItemAvailability({{ item.id }})"
                                                @change="toggleItemAvailability({{ item.id }})"
                                                :disabled="loading.includes({{ item.id }})"
                                            >
                                        </label>
                                    </div>

                                    <!-- Edit Button -->
                                    {% if user.is_staff %}
                                    <a href="/admin/vendors/menuitem/{{ item.id }}/change/" class="btn btn-outline btn-xs">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                        Edit
                                    </a>
                                    {% endif %}
                                </div>

                                <!-- Availability Status -->
                                <div class="mt-2">
                                    <div class="flex items-center justify-between">
                                        <span
                                            class="text-sm font-medium"
                                            :class="getItemAvailability({{ item.id }}) ? 'text-success' : 'text-error'"
                                        >
                                            <span x-text="getItemAvailability({{ item.id }}) ? 'Available for ordering' : 'Currently unavailable'"></span>
                                        </span>
                                        <div
                                            x-show="loading.includes({{ item.id }})"
                                            class="loading loading-spinner loading-sm"
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <!-- Empty Category State -->
                    <div class="text-center py-8">
                        <div class="text-4xl mb-2">üìù</div>
                        <h4 class="text-lg font-medium text-base-content/70 mb-2">No items in this category</h4>
                        <p class="text-base-content/50 mb-4">Start building your menu by adding items to this category.</p>
                        {% if user.is_staff %}
                        <a href="/admin/vendors/menuitem/add/?category={{ category.id }}" class="btn btn-primary btn-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add First Item
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- No Categories State -->
        <div class="card bg-base-200 shadow-lg">
            <div class="card-body text-center py-16">
                <div class="text-6xl mb-4">üìÇ</div>
                <h3 class="text-2xl font-bold text-base-content/70 mb-2">No Categories Found</h3>
                <p class="text-base-content/50 mb-6">Create categories to organize your menu items.</p>
                {% if user.is_staff %}
                <a href="/admin/vendors/category/add/?vendor={{ vendor.id }}" class="btn btn-primary">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Create First Category
                </a>
                {% else %}
                <p class="text-sm text-base-content/60">Contact an administrator to set up your menu categories.</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="mt-8">
            <div class="card bg-base-200 shadow-lg">
                <div class="card-body">
                    <h3 class="card-title mb-4">Quick Actions</h3>
                    <div class="flex flex-wrap gap-2">
                        <a href="{% url 'vendors:vendor_dashboard' vendor.id %}" class="btn btn-outline btn-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2-2V7a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 002 2h2a2 2 0 012-2V7a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 00-2 2h-2a2 2 0 00-2 2v6a2 2 0 01-2 2H7a2 2 0 01-2-2z"></path>
                            </svg>
                            Dashboard
                        </a>
                        <a href="{% url 'vendors:kitchen_display' %}" class="btn btn-outline btn-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path>
                            </svg>
                            Kitchen Display
                        </a>
                        {% if user.is_staff %}
                        <a href="/admin/vendors/category/add/?vendor={{ vendor.id }}" class="btn btn-primary btn-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add Category
                        </a>
                        <a href="/admin/vendors/menuitem/add/" class="btn btn-primary btn-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add Menu Item
                        </a>
                        {% endif %}
                    </div>

                    {% if not user.is_staff %}
                    <div class="mt-4 p-4 bg-info/10 rounded-lg">
                        <p class="text-sm text-info">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            To add/edit menu items, logos, or vendor information, contact an administrator who can help through the admin panel.
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Toast -->
    <div
        x-show="showToast"
        x-transition
        class="toast toast-top toast-end z-50"
    >
        <div class="alert" :class="toastType === 'success' ? 'alert-success' : 'alert-error'">
            <span x-text="toastMessage"></span>
        </div>
    </div>
</div>

<script>
function menuManagement() {
    return {
        // Track item availability state
        itemAvailability: {
            {% for category in categories %}
                {% for item in category.menu_items.all %}
                {{ item.id }}: {{ item.is_available|yesno:"true,false" }},
                {% endfor %}
            {% endfor %}
        },
        loading: [],
        showToast: false,
        toastMessage: '',
        toastType: 'success',

        getItemAvailability(itemId) {
            return this.itemAvailability[itemId] || false;
        },

        async toggleItemAvailability(itemId) {
            if (this.loading.includes(itemId)) return;

            this.loading.push(itemId);

            try {
                const response = await fetch(`{% url 'vendors:toggle_menu_item' vendor.id %}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        item_id: itemId
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    this.itemAvailability[itemId] = data.is_available;
                    this.showToastMessage(data.message, 'success');
                } else {
                    this.showToastMessage(data.error || 'Failed to update item availability', 'error');
                }
            } catch (error) {
                console.error('Error toggling item availability:', error);
                this.showToastMessage('Network error occurred', 'error');
            } finally {
                this.loading = this.loading.filter(id => id !== itemId);
            }
        },

        showToastMessage(message, type = 'success') {
            this.toastMessage = message;
            this.toastType = type;
            this.showToast = true;

            setTimeout(() => {
                this.showToast = false;
            }, 3000);
        }
    }
}
</script>
{% endblock %}
